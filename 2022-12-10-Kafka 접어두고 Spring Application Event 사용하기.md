---
aliases: []
categories: []
date-created: December 10, 2022 2:01 PM
Project: Recody
tags: [Architecture, Spring, 개발 일반]
date-updated: 2023-02-27 06:08
---
<br><br>
## 1. 문제

- Kafka 및 zookeeper 를 도커로 ECS 에 올려 사용하고 있었다.
- 프리티어 EC2 사양에 맞게 프로그램이 요구하는 기본 사양보다 매우 낮은 수준으로 설정하였다.
- 매우 적은 트래픽에도 쉽게 다운되어 health check 가 실패, 애플리케이션과 연결할 수 없는 문제가 발생.
- 이로 인해 백엔드 서버의 기능이 안정적으로 동작하지 않는 문제가 잦게 발생함.
- 또한 프리티어이지만 확장가능 인스턴스로, CPU 크레딧 사용으로 인한 비용 청구가 적지만 계속됨.
- 완전관리형인 Amazon MSK 를 도입하면 비용이 상당히 큼.
<br><br>
## 2. 해결 방법

- 서버 애플리케이션은 Modular Monolith 아키텍처로, 여러 서비스 바운더리를 가지고 있고 여러 모듈로 구분되지만 결국은 하나의 애플리케이션으로 구동되는 상황.
- 따라서 하나의 애플리케이션이 Publisher, Consumer 역할을 모두 가지고 동작하고 있는 상황.
- 확장하기 쉬운 구조를 위해서 선택한 아키텍처지만 Kafka 를 동시에 관리하기가 버겁다고 판단하였다.
- **어차피 Monolith 애플리케이션이기 때문에 스프링의 Application Event 로도 충분히 처리 가능** 하다고 판단하였다.
<br><br>
## 3. 해결

> **아래 글에서 자세한 구현을 하였다.**
> 
> 
> [`@Condition` 사용하여 설정에 따라 다른 빈을 등록하기](2022-11-22-@Condition%20사용하여%20설정에%20따라%20다른%20빈을%20등록하기.md) 
> 
- 모든 이벤트의 publish, subscribe(consume) 하는 로직은 인터페이스에 의존하도록 구현이 되어있었다.
- 따라서 해당 인터페이스의 구현체를 Kafka 구현체에서 Spring Event 관련 **구현체로 변경하기만 하면 전반적인 로직에 전혀 손을 댈 필요가 없었다.**
- 어떤 구현체를 사용할 것인지 외부에서 설정을 해주기만 하면 기존 Kafka 구현체를 지우거나 할 필요도 없다.
<br><br>
## 4. 주의점

### 이벤트 관련

- 스프링 이벤트의 경우 매우 단순하여 외부 인프라에 의존하지 않고 자바 객체라면 이벤트를 발행, 소비하는 데에 걸림이 없다.
- 하지만 조심하지 않는다면 이러한 이벤트들을 Kafka 와 같은 외부 인프라를 도입하여 처리하도록 바꿀 때 serialize / deserialize 하는 과정이 복잡해질 수 있다.
- 따라서 event 클래스는 최대한 가볍게 정의하는 것이 좋을 것이다.
- Domain 이벤트와 Integration 이벤트가 뒤섞인다.
    - [2022-12-30-Domain Events vs Integration Event](2022-12-30-Domain%20Events%20vs%20Integration%20Event.md)

### 쓰레드 관련

- 보통 스프링의 `@EventListener` 를 `@Async` 와 함께 사용한다.
- 카프카나 기타 메시지큐 미들웨어들은 각 메시지 / 이벤트 들을 순서대로 처리한다.
- 하지만 비동기로 이벤트를 소비하는 스프링 이벤트 리스너의 경우 짧은 시간에 많은 이벤트가 발생되면 이벤트가 처리되는 순서를 보장하지 못한다.
- 또한 지나치게 많은 쓰레드를 사용하는 문제도 있다.
- 따라서 이 부분은 적은 쓰레드로 구성된 쓰레드 풀로 적당히 나누어 처리하도록 만들었다.(또는 싱글 쓰레드로 만든다면 순서 측면도 해결가능해 보인다.)

### 기타 문제

- 메시지 큐가 아니기 때문에 특정 메시지가 소비되는 것을 보장할 수 없다.
- 즉, 이벤트를 발행하더라도 그 시점에 리스너가 구현되어 있지 않거나 정상 동작하지 않으면 그 이벤트는 소실된다.
- 가장 간단하게 구현해볼 수 있는 것은 이벤트를 따로 DB 에 저장하고 소비되었는지 확인하는 Outbox 패턴이 있겠다.